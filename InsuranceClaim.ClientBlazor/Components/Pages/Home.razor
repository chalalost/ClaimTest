@page "/"
@using InsuranceClaim.ClientBlazor.Components.Layout.Shared
@inject HttpClient http
@inject NavigationManager Navigation

<PageTitle>Claims List</PageTitle>

<div class="container mt-5">
    <h3>Claims List</h3>

    <!-- Status Filter -->
    <div class="mb-3">
        <label for="statusFilter" class="form-label">Filter by Status</label>
        <select class="form-select" id="statusFilter" @bind="statusFilter">
            <option value="" >All</option>
            <option @onclick="() => FilteredClaims(EnumStatus.Pending)">Pending</option>
            <option @onclick="() => FilteredClaims(EnumStatus.Approved)">Approved</option>
            <option @onclick="() => FilteredClaims(EnumStatus.Rejected)">Rejected</option>
        </select>
    </div>

    <!-- Claims Table -->
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Customer Name</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var claim in claims)
            {
                <tr>
                    <td>@claim.CustomerName</td>
                    <td>@claim.ClaimAmount.ToString("C")</td>
                    <td class="@GetStatusClass(claim.ClaimStatus)">
                        @claim.ClaimStatus
                    </td>
                    <td>
                        @if (claim.ClaimStatus == EnumStatus.Pending)
                        {
                            <button class="btn btn-warning" @onclick="() => ProcessClaim(claim.Id)">Process</button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <!-- New Claim Form -->
    <button class="btn btn-primary" @onclick="ToggleForm">Create New Claim</button>

    @if (showSubmitForm)
    {
        <div class="modal-overlay">
            <div class="modal">
                <h4>Submit New Claim</h4>
                <form @onsubmit="SubmitClaim">
                    <div class="mb-3">
                        <label for="customerName" class="form-label">Customer Name</label>
                        <input id="customerName" type="text" class="form-control" @bind="newClaim.CustomerName" required />
                    </div>
                    <div class="mb-3">
                        <label for="claimAmount" class="form-label">Claim Amount</label>
                        <input id="claimAmount" type="number" class="form-control" @bind="newClaim.ClaimAmount" required />
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea id="description" class="form-control" @bind="newClaim.ClaimDescription"></textarea>
                    </div>
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" @onclick="CloseForm">Close</button>
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    }
</div>

@code {
    [CascadingParameter]
    private List<ClaimDto> claims{ get; set; } = new List<ClaimDto>();
    [CascadingParameter]
    private ClaimSubmitDto newClaim{ get; set; } = new ClaimSubmitDto();
    private EnumStatus statusFilter;
    private bool showSubmitForm = false;

    protected override async Task OnInitializedAsync()
    {
        var response = await http.GetFromJsonAsync<List<ClaimDto>>("http://localhost:5000/api/Claims/get-all-claims");
        claims = response ?? new List<ClaimDto>();
    }

    private async Task FilteredClaims(EnumStatus status)
    {
        if(status == null)
        {
            var response = await http.GetFromJsonAsync<List<ClaimDto>>("http://localhost:5000/api/Claims/get-all-claims");
            claims = response ?? new List<ClaimDto>();
        }
        else
        {
            var response = await http.GetFromJsonAsync<List<ClaimDto>>("http://localhost:5000/api/Claims/retrieve-claims?status={status}");
            claims = response ?? new List<ClaimDto>();
        }
    }

    private string GetStatusClass(EnumStatus status)
    {
        return status switch
        {
            EnumStatus.Pending => "text-warning",
            EnumStatus.Approved => "text-success",
            EnumStatus.Rejected => "text-danger",
            _ => "text-muted"
        };
    }

    private async Task ProcessClaim(Guid claimId)
    {
        var response = await http.PostAsync($"http://localhost:5000/api/Claims/process-claim/{claimId}", null);
        if (response.IsSuccessStatusCode)
        {
            Navigation.NavigateTo("/abc");
        }
        else
        {
            
        }
    }

    private void ToggleForm()
    {
        showSubmitForm = !showSubmitForm;
    }

    private void CloseForm() => showSubmitForm = false;

    private async Task SubmitClaim()
    {
        var response = await http.PostAsJsonAsync("http://localhost:5000/api/Claims/submit-claim", newClaim);
        if (response.IsSuccessStatusCode)
        {
            Navigation.NavigateTo("/");
        }
        else
        {

        }
    }
}